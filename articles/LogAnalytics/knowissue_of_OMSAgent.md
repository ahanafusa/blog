---
title: OMS エージェントにおいて証明書更新後に発生する既知の不具合について
date: 2023-06-25 00:00:00
tags:
  - FAQ
  - Log Analytics
  - Troubleshooting
---

こんにちは、Azure Monitoring サポート チームの秋田です。
よくお問い合わせをいただいております OMS エージェント (Linux OS でご利用いただく Log Analytics エージェント) の既知の不具合の影響・原因・該当する事象かを判別する方法・回避策 についてご紹介いたします。

<br>

<!-- more -->

# 本不具合の内容および発生原因
エージェントでは定期的に (およそ 1 年に 1 回程度の間隔であり、2 か月前後する可能性もございます) 証明書の更新を行います。
OMS エージェントでは証明書を更新後 OMS エージェントを再起動するまで、更新前の古い証明書を使用して通信を試みてしまいます。
通信を試みる際に使用している証明書 (更新前の証明書) は、Azure 基盤側で認識している証明書 (更新後の証明書) と異なる証明書のため、
接続が拒絶されてしまい、それにより Log Analytics ワークスペースにログが収集できなくなる不具合が発生しております。

# 該当する事象かを判別する方法
後述のコマンドを事象発生マシンにて実行いただくことで、証明書の有効期限を確認いただくことが可能でございます。
~~~~~
sudo openssl x509 -text -noout -in /etc/opt/microsoft/omsagent/<workspace id>/certs/oms.crt
~~~~~
<workspace id> には対象となる Log Analytics のワークスペース ID を入力します。
ワークスペース ID は、Log Analytics ワークスペースの「エージェント管理」画面にてご確認いただけます。

実行結果例 (抜粋) は以下の通りです。
~~~~~
Validity
            Not Before: Jun 17 03:46:13 2023 GMT
            Not After : Jun 16 03:46:13 2024 GMT
~~~~~
上述の結果より、当該証明書の有効期限は 2023 年 6 月 17 日 03:46:13　GMT から 2024 年 6 月 16 日 03:46:13 GMT であることが分かります。
これより、証明書が更新されたタイミングは 2023 年 6 月 17 日 03:46:13　GMT 頃であることが分かります。

事象の発生が証明書更新終了タイミング近辺である場合、本不具合に該当する可能性が高いです。


# 対処方法
OMS エージェントの再接続を実施いただくことでログが再び送信されるようになります。
エージェントの再起動については、以下のコマンドにより実施いただけます。
~~~~~
sudo /opt/microsoft/omsagent/bin/service_control restart
~~~~~

もしくは、次回の証明書更新が近づきました際に、後述の手順により OMS エージェントの再接続を実行いただくことで、
新たに 1 年後を期限とした証明書が再作成されます。

<影響範囲>
エージェントの再接続を実施します。
そのため、作業が完了するまでの間ログの送信は停止します。
なお、OS 自体の設定を変更する作業等ではないため、手順実施による影響は特にございません。
 
<手順>
1. OS 上に以下のコマンドを実行し、ワークスペースとの接続を解除いたします。
- コマンド
$ sudo /opt/microsoft/omsagent/bin/omsadmin.sh -X
 
2. 以下のコマンドを実行し、再度ワークスペースへと接続いたします。
- コマンド
$ sudo /opt/microsoft/omsagent/bin/omsadmin.sh -w <workspace id> -s <shared key> -p <Proxy Conf> -v

<workspace id> には対象となる Log Analytics のワークスペース ID を入力します。
<shared key> には対象の Log Analytics の主キーを入力します。
それぞれ、Log Analytics ワークスペースの「エージェント管理」画面にて [ワークスペース ID] と [主キー] の箇所にてご確認いただけます。

<Proxy Conf> には、対象のプロキシ サーバーの値を入力します。プロキシをお使いの場合、こちらで指定してください。
例:
-p https://<proxy user>:<proxy password>@<proxy address>:<proxy port>


# 修正予定について
本問題については、弊社開発部門においても不具合を把握しております。
ただ、OMS エージェントは 2024 年 8　月 31 日を過ぎるとサポートがされなくなること、また事象の発生頻度が 1 年に 1 度程度であることから、
本問題の修正の優先度が非常に低い状況でございます。
場合によっては、不具合が修正されないままサポート終了日である 2024 年 8 月 31 日を迎える可能性もございます。
修正予定について、ご案内できる状況になく申し訳ございません。

# 代替案
OMS エージェントの後継である Azure Monitor エージェントへの移行もご検討いただけますと幸いです。
URL

以上、OMS エージェントで発生している既知の問題と対処方法をご案内いたしました。
弊社製品の不具合によりご不便ご迷惑おかけし申し訳ございません。
本不具合の修正状況等について何らかのアップデートがありました際には、本記事を更新いたします。

